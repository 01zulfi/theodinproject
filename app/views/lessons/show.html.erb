<%= content_for :title, title("#{@lesson.course.title} -- #{@lesson.title}",true) %>
<div id="lesson-nav">
  <div class="inner-nav">
    <%= link_to "Course List", courses_path %> >> 
    <%= link_to "#{@lesson.course.title}", lessons_path(@lesson.course.title_url) %> >> 
    <%= link_to "#{@lesson.section.title}", lessons_path(@lesson.course.title_url, :anchor => "section-#{@lesson.section.title_url}") %> >> 
    <% if @lesson.is_project %>
      Project:
    <% else %>
      <%= "#{@lesson_position_in_section}:" %>
    <% end %>
    <%= @lesson.title %>
  </div>
</div>

<!-- progress-tracking bar -->

<% if user_signed_in? %>
  <% lessons = @lesson.course.lessons.order(:position => :asc) %>
  <% pct = (100.0 / (lessons.count + 1.0)).to_f %>
  <% course_pct = @lesson.course.percent_completed_by(current_user) %>

  <div id="lc-progress-bar">
    <div class="lc-progress-wrapper">
      <%= link_to lessons_path(@lesson.course.title_url) do %>
        <div  class="lc-end-circle <%= course_pct == 100 ? 'lc-completed' : '' %>" 
              title="Go back to <%= @lesson.course.title %>"
              style="0%">
        </div>
      <% end %>
      <%= link_to lessons_path(@lesson.course.title_url) do %>
        <div  class="lc-end-circle lc-right-end <%= course_pct == 100 ? 'lc-completed' : '' %>" 
              title="Go back to <%= @lesson.course.title %>"
              style="0%">
        </div>
      <% end %>

      <% lessons.each_with_index do |l,i| %>
        <% if l == @lesson %>
          <div class="pending-line"></div>
          <div class="completed-line" style="width: <%= (i+1) * pct %>%"></div>
          <%= link_to "#" do %>
            <div  class="lc-active-circle" 
                  title="You've completed <%= course_pct.to_i %>% of this course"
                  style="left:<%= (i+1)*pct %>%">
              <span class="lc-pct"><%= course_pct.to_i %>%</span>
            </div>
          <% end %>
        <% else %>
          <% classes =  "lc-circle" %>
          <% classes <<  ( current_user.completed_lesson?(l) ? ' lc-complete' : ' lc-pending' ) %>
          <% classes << ( l.is_project ? ' lc-project' : ' lc-lesson' ) %>
          <%= link_to lesson_path(l.course.title_url, l.title_url) do %>
            <div  class="<%= classes %>" 
                  title="<%= l.is_project ? "Project:" : "" %> <%= l.title %>"
                  style="left:<%= (i+1)*pct %>%">
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

<% end %>

<!-- END progress-tracking bar -->

<div class="individual-lesson <%= @lesson.is_project ? 'project-lesson' : ''%>">
  <div class="container">

    <% if user_signed_in? %>
      <h3 class="lc-completion-indicator <%= current_user.completed_lesson?(@lesson) ? '' : 'hidden' %>" title="You've completed this lesson!">
        &#10004;
      </h3>
    <% end %>

    <%= @content %>

    <%= render 'lessons/contribution_links' %>
    <div class="action-box">
      <div class="lc-end-wrapper">
        <%= render "shared/complete_lesson" %>
      </div>

      <div class="lnav">

        <div class="lnav-prev lnav-wrap <%= 'lnav-disabled' unless @prev_lesson %> ">
          <% if @prev_lesson %>
            <%= link_to lesson_path(@course.title_url, @prev_lesson.title_url), :title => "Go back to \"#{@prev_lesson.title}\""  do %>
              <div class="lnav-prev-icon icon"></div>
              <div class="lnav-text">
                <p>Prev</p><p>Lesson</p>
              </div>
            <% end %>
          <% else %>
            <div class="lnav-prev-icon icon"></div>
            <div class="lnav-text">
              <p>Previous</p><p>Lesson</p>
            </div>
          <% end %>
        </div>

        <div class="lnav-index lnav-wrap">
          <%= link_to lessons_path(@course.title_url), :title => "Go back to \"#{@course.title}\""  do %>
            <div class="lnav-course-icon icon <%= 'lnav-active' if user_signed_in? && current_user.completed_lesson?(@lesson) && @next_lesson.nil? %>"></div>
            <div class="lnav-text">
              <p>View</p><p>Course</p>
            </div>
          <% end %>
        </div>

        <div class="lnav-next lnav-wrap <%= 'lnav-disabled' unless @next_lesson %>">
          <% if @next_lesson %>
            <%= link_to lesson_path(@course.title_url, @next_lesson.title_url), :title => "Move on to \"#{@next_lesson.title}\"" do %>
              <div class="lnav-next-icon icon <%= 'lnav-active' if user_signed_in? && current_user.completed_lesson?(@lesson) && !@next_lesson.nil? %>"></div>
              <div class="lnav-text">
                <p>Next</p><p>Lesson</p>
              </div>
            <% end %>
          <% else %>
            <div class="lnav-next-icon icon"></div>
            <div class="lnav-text">
              <p>Next</p><p>Lesson</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(function(){
    $(".individual-lesson a[href^='http://']").attr("target","_blank");
  });
</script>
